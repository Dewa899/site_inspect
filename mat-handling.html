<script>
(() => {
  // Jalankan inisialisasi setelah DOM siap (aman untuk inline / external / Android WebView)
  function ready(fn){
    if (document.readyState !== 'loading') fn();
    else document.addEventListener('DOMContentLoaded', fn, { once:true });
  }

  ready(function initApp(){
    /* ==== LANGUAGE STATE ==== */
    let currentLang = (localStorage.getItem('mhc_lang') === 'en') ? 'en' : 'id';
    const getLang = () => currentLang;

    /* ==== SCORING ==== */
    function scoreSection(sec){
      if(!sec) return 0;
      const names = new Set();
      sec.querySelectorAll('input[type=radio]').forEach(r=>names.add(r.name));
      let yes=0, denom=0;
      names.forEach(n=>{
        const chosen = sec.querySelector(`input[name="${CSS.escape(n)}"]:checked`);
        if(!chosen || chosen.value==='na') return;
        denom++; if(chosen.value==='yes') yes++;
      });
      return denom? Math.round(100*yes/denom):0;
    }
    function refreshScores(){
      const A = document.querySelector('tbody[data-section="A"]');
      const B = document.querySelector('tbody[data-section="B"]');
      const C = document.querySelector('tbody[data-section="C"]');
      const D = document.querySelector('tbody[data-section="D"]');
      const sA = scoreSection(A), sB = scoreSection(B), sC = scoreSection(C), sD = scoreSection(D);

      let yes=0, denom=0;
      [A,B,C,D].forEach(sec=>{
        if(!sec) return;
        const names = new Set();
        sec.querySelectorAll('input[type=radio]').forEach(r=>names.add(r.name));
        names.forEach(n=>{
          const chosen = sec.querySelector(`input[name="${CSS.escape(n)}"]:checked`);
          if(!chosen || chosen.value==='na') return;
          denom++; if(chosen.value==='yes') yes++;
        });
      });
      const total = denom? Math.round(100*yes/denom):0;

      const el = id => document.getElementById(id);
      el('scoreA') && (el('scoreA').textContent = sA + '%');
      el('scoreB') && (el('scoreB').textContent = sB + '%');
      el('scoreC') && (el('scoreC').textContent = sC + '%');
      el('scoreD') && (el('scoreD').textContent = sD + '%');
      el('totalScore') && (el('totalScore').textContent = total + '%');

      const badge = el('badge');
      if(badge){
        badge.textContent = `${total}/100`;
        badge.classList.remove('good','bad');
        badge.classList.add(total>=80 ? 'good' : 'bad');
      }
    }

    /* ==== LIMIT HELPERS ==== */
    function enforceMaxWithAlert(el, MAX, fieldName){
      if(!el) return false;
      if(el.value.length > MAX){
        el.value = el.value.slice(0, MAX);
        const lang = getLang();
        const msg = lang==='en'
          ? `Maximum ${MAX} characters for ${fieldName}. Text has been truncated to meet the requirement.`
          : `Maksimal ${MAX} karakter untuk ${fieldName}. Teks telah dipotong agar sesuai ketentuan.`;
        alert(msg);
        return true;
      }
      return false;
    }

    /* ==== REMARKS (70) ==== */
    const MAX_REMARKS = 70;
    function updateCounter(area){
      if(!area) return;
      const wrap = area.closest('.remarks-wrap');
      if(!wrap) return;
      const counter = wrap.querySelector('.counter');
      if(!counter) return;
      const len = area.value.length;
      counter.textContent = `${len}/${MAX_REMARKS}`;
      counter.classList.toggle('limit', len >= MAX_REMARKS);
    }

    /* ==== PHOTOS (58) ==== */
    const MAX_DESC = 58;

    /* ==== i18n ==== */
    function getQuestionMap(){
      const map = {};
      document.querySelectorAll('.chk-table tbody tr').forEach(tr=>{
        const no = tr.querySelector('.col-no');
        const q = tr.querySelector('.ques');
        if(no && q){ map[no.textContent.trim()] = q; }
      });
      return map;
    }
    const qMap = getQuestionMap();

    const baselineID = {};
    Object.keys(qMap).forEach(k => baselineID[k] = qMap[k].textContent.trim());

    const i18n = {
      id: {
        labels: {
          label_site: "Site Assesssor",
          label_project: "Project",
          label_date: "Date",
          label_location: "Location",
          label_contractor: "Kontraktor",
          th_no: "No.",
          th_question: "Pertanyaan",
          th_yes: "YES",
          th_no2: "NO",
          th_na: "N/A",
          ph_assessor: "Nama Site Assesssor",
          ph_project: "Kode/Nama",
          ph_location: "Lokasi",
          ph_contractor: "Nama Kontraktor",
          ph_remarks: "Remarks (maks 70 karakter)…",
          ph_photo: "Deskripsi foto (maks 58)…",
          radio_yes: "Ya",
          radio_no: "Tidak",
          radio_na: "N/A"
        },
        questions: baselineID
      },
      en: {
        labels: {
          label_site: "Site Assessor",
          label_project: "Project",
          label_date: "Date",
          label_location: "Location",
          label_contractor: "Contractor",
          th_no: "No.",
          th_question: "Question",
          th_yes: "YES",
          th_no2: "NO",
          th_na: "N/A",
          ph_assessor: "Site assessor name",
          ph_project: "Code/Name",
          ph_location: "Location",
          ph_contractor: "Contractor name",
          ph_remarks: "Remarks (max 70 characters)…",
          ph_photo: "Photo description (max 58)…",
          radio_yes: "Yes",
          radio_no: "No",
          radio_na: "N/A"
        },
        questions: {
          A1: "Is the placement of materials compliant with the MSRA location and storage requirements?",
          A2: "Have the material weight/dimensions and movement method been discussed? (check the MSRA; plan vehicle route and consider load weight)",
          A3: "Does the material placement not obstruct pedestrians, provide access for picking, and are barricades provided?",
          A4: "Do you know the manual lifting limit is 18.14 kg per person, and loads longer than 3 m must be lifted by more than one person?",
          B5: "Whom do you report to if you need equipment to move your materials?",
          B6: "Have you checked that the handling/lifting equipment has been pre-use checklisted?",
          B7: "Do the handling/lifting equipment operators hold a valid license (SIO)?",
          C8: "Is the lifting equipment certification (SILO) available and valid?",
          C9: "Has the handling (lifting) equipment been inspected before being mobilized/used?",
          C10:"Have other auxiliary tools been inspected and declared fit for use?",
          C11:"Is the PPE in accordance with MSDS requirements?",
          D12:"Do you have waste bins for leftover materials to be disposed of?",
          D13:"Do you know the daily location of your waste collection points?",
          D14:"Do you clean before and after work and tidy up the tools?",
          D15:"If your materials are inside the building, do you provide floor protection and prevent dust generation?"
        }
      }
    };

    function setPlaceholders(lang){
      const byId = id => document.getElementById(id);
      const L = i18n[lang]?.labels || {};
      byId('inp-assessor') && (byId('inp-assessor').placeholder = L.ph_assessor || '');
      byId('inp-project')  && (byId('inp-project').placeholder  = L.ph_project  || '');
      byId('inp-location') && (byId('inp-location').placeholder = L.ph_location || '');
      byId('inp-contractor') && (byId('inp-contractor').placeholder = L.ph_contractor || '');
      document.querySelectorAll('textarea.remarks').forEach(t=> t.placeholder = L.ph_remarks || t.placeholder);
      document.querySelectorAll('.photo-desc').forEach(p=> p.placeholder = L.ph_photo || p.placeholder);
    }
    function setLabels(lang){
      const L = i18n[lang]?.labels || {};
      document.querySelectorAll('[data-i18n]').forEach(el=>{
        const key = el.getAttribute('data-i18n');
        const txt = L[key];
        if(txt) el.textContent = txt;
      });
    }
    function setRadioLabels(lang){
      const L = i18n[lang]?.labels || {};
      const yesTxt = L.radio_yes || 'Yes';
      const noTxt  = L.radio_no  || 'No';
      const naTxt  = L.radio_na  || 'N/A';
      document.querySelectorAll('.yn label').forEach(lab=>{
        const inp = lab.querySelector('input');
        if(!inp) return;
        let txt = naTxt;
        if(inp.value==='yes') txt = yesTxt;
        else if(inp.value==='no') txt = noTxt;
        let textNode = Array.from(lab.childNodes).find(n=> n.nodeType===Node.TEXT_NODE);
        if(textNode){ textNode.nodeValue = ' ' + txt; }
        else{ lab.appendChild(document.createTextNode(' ' + txt)); }
      });
    }
    function setQuestions(lang){
      const dict = (i18n[lang]?.questions) || {};
      Object.keys(qMap).forEach(key=>{
        const el = qMap[key];
        if(!el) return;
        el.textContent = dict[key] || baselineID[key];
      });
    }
    function applyLanguage(lang){
      currentLang = (lang==='en') ? 'en' : 'id';
      setLabels(currentLang);
      setPlaceholders(currentLang);
      setQuestions(currentLang);
      setRadioLabels(currentLang);
      try{ localStorage.setItem('mhc_lang', currentLang); }catch(e){}
      const btnID = document.getElementById('btnID');
      const btnEN = document.getElementById('btnEN');
      btnID?.setAttribute('aria-pressed', currentLang==='id' ? 'true' : 'false');
      btnEN?.setAttribute('aria-pressed', currentLang==='en' ? 'true' : 'false');
    }

    /* ====== INITIALIZE ====== */
    applyLanguage(getLang());
    refreshScores();

    /* ====== EVENTS (delegation) ====== */

    // Radio scoring
    const tableEl = document.getElementById('chkTable');
    tableEl?.addEventListener('change', (e)=>{
      const t = e.target;
      if(t && t.matches('input[type=radio]')) refreshScores();
    });

    // Language buttons
    document.getElementById('btnID')?.addEventListener('click', ()=>applyLanguage('id'));
    document.getElementById('btnEN')?.addEventListener('click', ()=>applyLanguage('en'));

    // Remarks counter + limit
    document.addEventListener('input', (e)=>{
      const t = e.target;
      if(t && t.matches('textarea.remarks')){
        enforceMaxWithAlert(t, MAX_REMARKS, getLang()==='en'?'Remarks':'Remarks');
        updateCounter(t);
      }
      if(t && t.matches('.photo-card .photo-desc')){
        const desc = t;
        enforceMaxWithAlert(desc, MAX_DESC, getLang()==='en'?'Photo Description':'Deskripsi Foto');
        const printBox = desc.closest('.photo-card')?.querySelector('.photo-desc-print');
        if(printBox) printBox.textContent = desc.value ? desc.value : '';
      }
    });
    document.addEventListener('paste', (e)=>{
      const t = e.target;
      if(t && t.matches('textarea.remarks')){
        setTimeout(()=>{ enforceMaxWithAlert(t, MAX_REMARKS, getLang()==='en'?'Remarks':'Remarks'); updateCounter(t); },0);
      }
      if(t && t.matches('.photo-card .photo-desc')){
        setTimeout(()=>{
          const desc = t;
          enforceMaxWithAlert(desc, MAX_DESC, getLang()==='en'?'Photo Description':'Deskripsi Foto');
          const printBox = desc.closest('.photo-card')?.querySelector('.photo-desc-print');
          if(printBox) printBox.textContent = desc.value ? desc.value : '';
        },0);
      }
    });

    // Photo upload preview
    document.addEventListener('change', (e)=>{
      const inp = e.target;
      if(inp && inp.matches('.photo-card input[type=file]')){
        const file = inp.files && inp.files[0]; if(!file) return;
        const stage = inp.closest('.photo-card')?.querySelector('.photo-stage');
        if(!stage) return;
        const img = document.createElement('img');
        const rd = new FileReader();
        rd.onload = ev=>{ stage.innerHTML=''; img.src = ev.target.result; stage.appendChild(img); };
        rd.readAsDataURL(file);
      }
    });

    // Print & Reset
    document.getElementById('printBtn')?.addEventListener('click', (e)=>{ e.preventDefault(); window.print(); });
    document.getElementById('resetBtn')?.addEventListener('click', ()=>{
      document.querySelectorAll('#chkTable input[type=radio]').forEach(r=>{ r.checked=false; });
      document.querySelectorAll('textarea.remarks').forEach(t=>{ t.value=''; updateCounter(t); });
      document.querySelectorAll('.photo-card').forEach(card=>{
        const stage = card.querySelector('.photo-stage'); if(stage) stage.innerHTML='<span>Add Photo</span>';
        const f = card.querySelector('input[type=file]'); if(f) f.value='';
        const d = card.querySelector('.photo-desc'); if(d){ d.value=''; }
        const pb = card.querySelector('.photo-desc-print'); if(pb){ pb.textContent=''; }
      });
      refreshScores(); window.scrollTo({top:0,behavior:'smooth'});
    });
  });
})();
</script>
