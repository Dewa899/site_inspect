<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Vibration Exposure Simulation A(8) - Decision Support Tool</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>
<style>
  :root{
    /* Palet lembut (screen) */
    --bg1:#0f172a; --bg2:#111827;
    --card:#111827;
    --ink:#e5e7eb;
    --muted:#b6c1d6;
    --accent:#7dd3fc;
    --ok:#86efac; --warn:#facc15; --bad:#fb7185;
    --br:16px;
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
    color:var(--ink);
    background:linear-gradient(180deg,var(--bg1),var(--bg2));
  }
  header{padding:22px 16px 8px;text-align:center}
  header h1{margin:0 0 6px;font-weight:700;letter-spacing:.2px}
  header p{margin:0;color:var(--muted)}
  .wrap{max-width:1100px;margin:18px auto 40px;padding:0 16px}
  .toolbar{display:flex;gap:8px;flex-wrap:wrap;justify-content:center;margin:8px 0 16px}
  .btn{cursor:pointer;padding:10px 14px;border-radius:10px;border:1px solid rgba(255,255,255,.18);background:#0e1530;color:var(--ink)}
  .btn:hover{border-color:var(--accent)}
  select{padding:10px;border-radius:10px;background:#0b1326;color:var(--ink);border:1px solid rgba(255,255,255,.18)}
  .card{
    background:linear-gradient(180deg,#121a2f,#0f162b);
    border:1px solid rgba(255,255,255,.06);
    border-radius:var(--br);
    padding:18px;
    box-shadow:0 10px 30px rgba(0,0,0,.35);
    margin-bottom:14px;
    transition: border-color .3s, box-shadow .3s; /* Transisi untuk highlight */
  }
  /* Style untuk highlight kontekstual */
  .card.highlight-warn{
    border-color: rgba(250, 204, 21, 0.6);
    box-shadow: 0 0 15px rgba(250, 204, 21, 0.2);
  }
  .card.highlight-bad{
    border-color: rgba(251, 113, 133, 0.6);
    box-shadow: 0 0 15px rgba(251, 113, 133, 0.25);
  }
  .grid{display:grid;gap:14px}
  @media(min-width:980px){ .grid{grid-template-columns:1.08fr 1.12fr}}
  label{display:block;font-size:14px;color:var(--muted);margin-bottom:6px}
  input[type=number]{width:100%;padding:10px 12px;background:#0b1326;border:1px solid rgba(255,255,255,.12);color:var(--ink);border-radius:10px;outline:none}
  input[type=number]:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(125,211,252,.18)}
  .row{display:grid;gap:12px;grid-template-columns:repeat(4,1fr)}
  @media(max-width:720px){ .row{grid-template-columns:1fr}}
  .hint{font-size:12px;color:var(--muted)}
  .stat{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;background:#0e1733;border:1px solid rgba(255,255,255,.08);border-radius:12px;margin:8px 0}
  .stat b{font-size:18px}
  .pill{padding:4px 8px;border-radius:999px;font-size:12px;border:1px solid rgba(255,255,255,.15);color:var(--muted)}
  .ok{color:var(--ok);border-color:rgba(134,239,172,.35)}
  .warn{color:var(--warn);border-color:rgba(250,204,21,.35)}
  .bad{color:var(--bad);border-color:rgba(251,113,133,.35)}
  h2{margin:10px 0 8px}
  h3{margin:8px 0 6px}
  ul{margin:8px 0 0 18px}
  table{width:100%;border-collapse:separate;border-spacing:0;overflow:hidden;border-radius:12px;margin-top:8px}
  th,td{padding:10px 12px;text-align:left;border-bottom:1px solid rgba(255,255,255,.08)}
  th{font-weight:600;color:var(--muted);background:#101a36;position:sticky;top:0}
  tr:last-child td{border-bottom:none}
  #schedTable tbody tr { cursor: pointer; } /* Kursor interaktif untuk tabel */
  #schedTable tbody tr:hover { background: rgba(125, 211, 252, 0.08); }
  .small{font-size:12px;color:var(--muted)}
  .chartbox{width:100%;height:clamp(220px,36vw,320px)}
  canvas{width:100%!important;height:100%!important;background:#0f1a36;border-radius:12px;padding:8px}
  footer{max-width:1100px;margin:20px auto 60px;color:var(--muted);text-align:center;padding:0 16px}
  footer a{color:var(--accent);text-decoration:none}
  footer a:hover{text-decoration:underline}
  @media print{*{background:transparent !important;color:#000 !important;box-shadow:none !important;-webkit-print-color-adjust:exact;print-color-adjust:exact;}body{background:#fff !important}header p, .hint{color:#000 !important}.card, .stat, table, th, td{background:#fff !important; color:#000 !important; border-color:#000 !important}.pill{border-color:#000 !important; color:#000 !important; background:transparent !important}.chartbox{height:auto !important}canvas{width:140mm !important;height:140mm !important;background:#fff !important;padding:0 !important;border-radius:0 !important;}footer a{color:#000 !important}}
</style>
</head>
<body>
<header>
  <h1 id="t_title">Simulasi Paparan Getaran A(8) (EU 2002/44/EC)</h1>
  <p id="t_sub">Rumus: <span style="font-family:ui-monospace">A(8) = a‚Çï·µ• ¬∑ ‚àö(T / 8)</span>, T dalam jam; normalisasi ke 8 jam</p>
</header>

<div class="toolbar">
  <button class="btn" id="btnPrint">üñ®Ô∏è Print PDF</button>
  <label class="small" for="langSel" id="t_langlabel">Bahasa:</label>
  <select id="langSel">
    <option value="id">Indonesia (ID)</option>
    <option value="en">English (EN)</option>
  </select>
</div>

<div class="wrap">
  <div class="card grid">
    <div>
      <h2 id="t_inputs">Input</h2>
      <label for="ahv" id="t_ahvlabel">a‚Çï·µ• (m/s¬≤) ‚Äì RMS alat</label>
      <input id="ahv" type="number" step="0.01" min="0" value="2.50" />
      <div class="hint" id="t_ahvhint">Contoh: 2.50 m/s¬≤ (A(8) = 2.5 jika 8 jam penuh)</div>

      <div class="row" style="margin-top:10px">
        <div>
          <label for="targetA" id="t_targetlabel">Target A(8) (m/s¬≤)</label>
          <input id="targetA" type="number" step="0.01" min="0" value="2.20" />
          <div class="hint" id="t_targethint">Disarankan &lt; 2.50 sebagai margin aman</div>
        </div>
        <div>
          <label for="shiftH" id="t_shiftlabel">Durasi shift (jam)</label>
          <input id="shiftH" type="number" step="0.5" min="1" value="8" />
          <div class="hint" id="t_shifthint">Paparan ‚â§ durasi shift; A(8) tetap dinormalisasi 8 jam</div>
        </div>
        <div>
          <label for="toolHours" id="t_toolhlabel">Total jam alat/hari</label>
          <input id="toolHours" type="number" step="0.25" min="0" value="8" />
          <div class="hint" id="t_toolhhint">Untuk hitung operator minimum (rotasi)</div>
        </div>
        <div style="display:flex;align-items:end"><button class="btn" id="btnCalc">Hitung</button></div>
      </div>

      <div class="stat">
        <span id="t_a8fulltxt">Jika dipakai terus sepanjang shift, A(8) = <b id="a8full">‚Äî</b></span>
        <span class="pill" id="statusPill">‚Äî</span>
      </div>
      <div class="stat">
        <span id="t_tmax8txt">Durasi paparan maksimum (target, basis 8 jam): <b id="tmax8">‚Äî</b> jam</span>
        <span class="pill ok" id="t_targetpill">Target-based</span>
      </div>
      <div class="stat">
        <span id="t_tmaxlimtxt">Batas paparan dibatasi shift: <b id="tmaxLimited">‚Äî</b> jam</span>
        <span class="pill" id="t_shiftpill">Shift limit</span>
      </div>
      <div class="stat">
        <span id="t_perhourtxt">Rekomendasi per jam: <b id="perHour">‚Äî</b> (kerja + jeda)</span>
        <span class="pill" id="t_dutypill">Duty cycle</span>
      </div>
      <div class="stat">
        <span id="t_opsneedtxt">Kebutuhan operator (min): <b id="opsNeeded">‚Äî</b></span>
        <span class="pill" id="t_rotpill">Rotasi</span>
      </div>
    </div>

    <div>
      <h2 id="t_opts">Opsi Jadwal & A(8)</h2>
      <div class="small" id="t_presethint">Tambah baris: Work‚Ä≤ + Break‚Ä≤ per jam. <b>Klik baris untuk update chart donat.</b></div>
      <div style="margin:.5rem 0" class="flex">
        <button class="btn" id="btnAddPreset">+ Preset Kustom</button>
      </div>
      <table id="schedTable">
        <thead>
          <tr>
            <th id="t_colScheme">Skema per jam</th>
            <th>Duty</th>
            <th id="t_colT">T (jam/hari)</th>
            <th>A(8) (m/s¬≤)</th>
            <th id="t_colStatus">Status</th>
            <th></th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <div class="small" style="margin-top:6px" id="t_dutydef">
        Duty = menit kerja per jam / 60. T efektif = duty √ó durasi shift (‚â§ shift). A(8)=a‚Çï·µ•¬∑‚àö(T/8).
      </div>
    </div>
  </div>

  <div class="card grid">
    <div>
      <h3 id="t_chart1title">Chart: Work vs Break per Jam</h3>
      <div class="chartbox"><canvas id="chartWB"></canvas></div>
    </div>
    <div>
      <h3 id="t_chart2title">Chart: Analisis Risiko A(8) vs Durasi Shift</h3>
      <div class="chartbox"><canvas id="chartA8"></canvas></div>
      <div class="small" id="t_chart2hint">Kurva dihitung untuk duty aktif terpilih & a‚Çï·µ• saat ini</div>
    </div>
  </div>

  <div class="card" id="card-rotation">
    <h2 id="t_sec2">2. Rotasi Pekerja (Work Rotation)</h2>
    <p id="t_sec2p">
      Jika beban kerja total &gt; 8 jam per hari, bagi ke beberapa orang. Minimum operator =
      <span style="font-family:ui-monospace">ceil(TotalToolHours / T<sub>max</sub>)</span>.
    </p>
  </div>
  
  <div class="card" id="card-engineering">
    <h2 id="t_sec3">3. Engineering Controls (Kontrol Rekayasa)</h2>
    <ul id="t_sec3ul">
      <li>Gunakan model alat <em>low-vibration</em> & pegangan anti-vibration bawaan pabrik.</li>
      <li>Perawatan: balancing, alignment, penggantian bearing/brush; getaran naik saat komponen aus.</li>
    </ul>
  </div>

  <div class="card" id="card-administrative">
    <h2 id="t_sec4">4. Administrative Controls (Kontrol Administratif)</h2>
    <ul id="t_sec4ul">
      <li>Jadwalkan pekerjaan tinggi getaran di jam awal saat kondisi fisik optimal.</li>
      <li>Terapkan jadwal kerja & jeda (vibration breaks) untuk menurunkan paparan harian (T).</li>
      <li>Catat durasi paparan harian per operator; audit bulanan kepatuhan duty/jeda.</li>
    </ul>
  </div>
  
  <div class="card" id="card-technique">
    <h2 id="t_sec5">5. Pelatihan & Teknik Kerja</h2>
    <ul id="t_sec5ul">
      <li>Genggam ringan‚Äîhindari menekan alat berlebihan; biarkan sistem redam bekerja.</li>
      <li>Gunakan dua tangan bila memungkinkan; jaga postur untuk mengurangi transmisi ke lengan.</li>
    </ul>
  </div>
  
  <div class="card" id="card-ppe">
    <h2 id="t_sec6">6. PPE (APD)</h2>
    <ul id="t_sec6ul">
      <li>Sarung tangan anti-vibration (EN ISO 10819) ‚Äî efek terbatas di frekuensi rendah.</li>
      <li>Grip/handle ergonomis untuk menurunkan gaya genggam & slip.</li>
    </ul>
  </div>

  <div class="card">
    <p class="small" id="t_foot">Ambang EU: EAV = 2,5 m/s¬≤ (perlu tindakan); ELV = 5,0 m/s¬≤ (tidak boleh dilampaui). Hierarki kontrol: Rekayasa > Administratif > APD.</p>
  </div>
</div>

<footer>
  <div>Desaigned by Mokhamad Abrar</div>
  <div>Revewed by Ratu Avior, MSc.</div>
  <div>Sustainable Apps Development @ Aug 2025</div>
</footer>

<script>
// I18N Strings (disederhanakan untuk contoh)
const T = { id:{...}, en:{...} }; // Salin objek T dari skrip asli Anda ke sini
// <<< PASTIKAN OBJEK 'T' LENGKAP DISALIN DI SINI >>>

// (Untuk keringkasan, logika i18n tidak ditampilkan ulang, asumsikan sudah ada)
function setLang(newLang){ /* ... fungsi dari skrip asli ... */ }
function pillText(a8){ /* ... fungsi dari skrip asli ... */ }
function fmt(x,d=2){ if(!isFinite(x)) return "‚Äî"; return Number(x).toFixed(d); }


/*** Presets ***/
const defaultPresets = [
  {work:60, break:0,  labelID:"60‚Ä≤ kerja + 0‚Ä≤ jeda (kontinu)", labelEN:"60‚Ä≤ work + 0‚Ä≤ break (continuous)"},
  {work:50, break:10, labelID:"50‚Ä≤ kerja + 10‚Ä≤ jeda", labelEN:"50‚Ä≤ work + 10‚Ä≤ break"},
  {work:45, break:15, labelID:"45‚Ä≤ kerja + 15‚Ä≤ jeda", labelEN:"45‚Ä≤ work + 15‚Ä≤ break"},
  {work:30, break:30, labelID:"30‚Ä≤ kerja + 30‚Ä≤ jeda", labelEN:"30‚Ä≤ work + 30‚Ä≤ break"},
  {work:20, break:40, labelID:"20‚Ä≤ kerja + 40‚Ä≤ jeda", labelEN:"20‚Ä≤ work + 40‚Ä≤ break"}
];
let customPresets = [];
let lang = 'id'; // Default lang

/*** Charts ***/
let chartWB, chartA8;
const whiteBG = {id:'whiteBG',beforeDraw:(chart, args, opts)=>{const {ctx, chartArea} = chart;if(!chartArea) return;ctx.save();ctx.fillStyle = opts?.color || '#ffffff';ctx.fillRect(chartArea.left, chartArea.top, chartArea.right-chartArea.left, chartArea.bottom-chartArea.top);ctx.restore();}};
function buildCharts(){
  const ctx1=document.getElementById('chartWB');
  chartWB = new Chart(ctx1, {type:'doughnut',data:{labels:['Kerja','Jeda'], datasets:[{data:[50,10]}]},options:{responsive:true, maintainAspectRatio:false,plugins:{legend:{position:'bottom'}, whiteBG:{}}},plugins:[whiteBG]});

  const ctx2=document.getElementById('chartA8');
  chartA8 = new Chart(ctx2, {
    type:'line',
    data:{labels:[], datasets:[{label:'A(8)', data:[], tension:0.25, pointRadius:2, borderColor: 'var(--accent)', backgroundColor: 'rgba(125, 211, 252, 0.2)', fill: true}]},
    options:{
      responsive:true, maintainAspectRatio:false,
      plugins:{
        legend:{display:false},
        whiteBG:{},
        // --- FITUR BARU: Anotasi Batas Risiko ---
        annotation: {
          annotations: {
            eav: {
              type: 'box', yMin: 2.5, yMax: 5.0,
              backgroundColor: 'rgba(250, 204, 21, 0.15)',
              borderColor: 'rgba(250, 204, 21, 0.3)', borderWidth: 1
            },
            elv: {
              type: 'box', yMin: 5.0,
              backgroundColor: 'rgba(251, 113, 133, 0.15)',
              borderColor: 'rgba(251, 113, 133, 0.3)', borderWidth: 1
            },
            eavLine: {
              type: 'line', yMin: 2.5, yMax: 2.5,
              borderColor: 'var(--warn)', borderWidth: 1.5, borderDash: [6, 6],
              label: { content: 'EAV: Action Level (2.5)', position: 'start', enabled: true, font: {size: 10}, color: 'var(--warn)', backgroundColor: 'rgba(0,0,0,0.6)' }
            },
            elvLine: {
              type: 'line', yMin: 5.0, yMax: 5.0,
              borderColor: 'var(--bad)', borderWidth: 1.5,
              label: { content: 'ELV: Limit Value (5.0)', position: 'start', enabled: true, font: {size: 10}, color: 'var(--bad)', backgroundColor: 'rgba(0,0,0,0.6)' }
            }
          }
        }
      },
      scales:{
        x:{title:{display:true,text:'Durasi Shift (jam)'}},
        y:{title:{display:true,text:'A(8) (m/s¬≤)'}, min: 0}
      }
    },
    plugins:[whiteBG, ChartAnnotation]
  });
}

// ... Fungsi print dari skrip asli ...
let prevStates = {};
function beforePrint(){ /* ... */ }
function afterPrint(){ /* ... */ }
window.addEventListener('beforeprint', beforePrint);
window.addEventListener('afterprint', afterPrint);


/*** --- FITUR BARU: Highlight Kontekstual --- ***/
function updateContextualHighlights(a8) {
    const controlCards = {
        eng: document.getElementById('card-engineering'),
        rot: document.getElementById('card-rotation'),
        admin: document.getElementById('card-administrative'),
        tech: document.getElementById('card-technique'),
    };
    // Reset semua highlight
    Object.values(controlCards).forEach(card => {
        card.classList.remove('highlight-warn', 'highlight-bad');
    });

    if (a8 > 5.0) { // Risiko tinggi, butuh intervensi kuat
        controlCards.eng.classList.add('highlight-bad');
        controlCards.rot.classList.add('highlight-bad');
    } else if (a8 >= 2.5) { // Risiko waspada, butuh tindakan administratif
        controlCards.admin.classList.add('highlight-warn');
        controlCards.tech.classList.add('highlight-warn');
    }
}


/*** Core calc ***/
function recalc(){
  const ahv = parseFloat(document.getElementById('ahv').value);
  let targetA = parseFloat(document.getElementById('targetA').value);
  const shiftH = parseFloat(document.getElementById('shiftH').value);
  const toolHours = parseFloat(document.getElementById('toolHours').value);
  if(!isFinite(targetA) || targetA <= 0){ targetA = 2.20; document.getElementById('targetA').value = targetA; }

  const Tfull = shiftH;
  const a8full = ahv * Math.sqrt(Tfull/8);
  const pill = pillText(a8full);
  document.getElementById('a8full').textContent = fmt(a8full,2);
  const pillEl = document.getElementById('statusPill'); pillEl.textContent=pill.text; pillEl.className=pill.cls;

  const Tmax8 = 8 * Math.pow(targetA/ahv, 2);
  const TmaxLimited = Math.min(Tmax8, shiftH);
  document.getElementById('tmax8').textContent = fmt(Tmax8,2);
  document.getElementById('tmaxLimited').textContent = fmt(TmaxLimited,2);

  const duty = (shiftH>0)? (TmaxLimited/shiftH) : 0;
  const workMin = Math.round(60*duty);
  const breakMin = Math.max(0, 60 - workMin);
  document.getElementById('perHour').textContent = `${workMin}‚Ä≤ + ${breakMin}‚Ä≤`;
  
  let opsNeeded = "‚Äî";
  if(isFinite(toolHours) && toolHours>0 && TmaxLimited>0){
    opsNeeded = Math.ceil(toolHours / TmaxLimited);
  }
  document.getElementById('opsNeeded').textContent = opsNeeded;

  const rows=[...defaultPresets, ...customPresets];
  const tbody=document.querySelector('#schedTable tbody');
  tbody.innerHTML="";
  rows.forEach((p, idx)=>{
    const dutyRow = p.work/60;
    const T = dutyRow * shiftH;
    const A8 = ahv * Math.sqrt(T/8);
    const st = pillText(A8);
    const label = (lang==='id' ? (p.labelID || `${p.work}‚Ä≤ kerja + ${p.break}‚Ä≤ jeda`) : (p.labelEN || `${p.work}‚Ä≤ work + ${p.break}‚Ä≤ break`));
    const tr=document.createElement('tr');
    // --- FITUR BARU: Tambah data-attributes untuk interaktivitas ---
    tr.dataset.work = p.work;
    tr.dataset.break = p.break;
    tr.innerHTML = `<td>${label}</td><td>${Math.round(dutyRow*100)}%</td><td>${fmt(T,2)}</td><td>${fmt(A8,2)}</td><td><span class="${st.cls}">${st.text}</span></td><td>${idx>=defaultPresets.length ? `<button class="btn btn-del" data-idx="${idx}">üóë</button>` : ''}</td>`;
    tbody.appendChild(tr);
  });

  // update charts
  if (!chartWB.updatedFromTable) { // Hanya update jika tidak di-trigger oleh klik tabel
    chartWB.data.datasets[0].data=[workMin, breakMin];
    chartWB.update();
  }
  chartWB.updatedFromTable = false; // Reset flag

  const xs=[], ys=[];
  for(let sh=1; sh<=12; sh+=0.5){ // Rentang shift lebih relevan
    const T = duty * sh;
    const a8 = ahv * Math.sqrt(T/8);
    xs.push(sh.toFixed(1)); ys.push(+a8.toFixed(3));
  }
  chartA8.data.labels=xs;
  chartA8.data.datasets[0].data=ys;
  chartA8.update();

  // Panggil fungsi highlight
  updateContextualHighlights(a8full);
}


// ... Fungsi preset & delete dari skrip asli ...
function addPreset(){ /* ... */ }
document.addEventListener('click', (e)=>{ /* ... */ });


/*** --- FITUR BARU: Event Listener untuk Tabel Interaktif --- ***/
document.querySelector('#schedTable tbody').addEventListener('click', (e) => {
    const row = e.target.closest('tr');
    if (!row) return;

    const work = parseFloat(row.dataset.work);
    const breakVal = parseFloat(row.dataset.break);

    if (!isNaN(work) && !isNaN(breakVal)) {
        chartWB.data.datasets[0].data = [work, breakVal];
        chartWB.updatedFromTable = true; // Set flag agar recalc tidak menimpa
        chartWB.update();
    }
});


/*** Events ***/
document.getElementById('btnPrint').addEventListener('click', ()=>window.print());
document.getElementById('btnCalc').addEventListener('click', recalc);
document.getElementById('btnAddPreset').addEventListener('click', addPreset);
document.getElementById('langSel').addEventListener('change', (e)=>{ setLang(e.target.value); });
['ahv','targetA','shiftH','toolHours'].forEach(id=>{
  document.getElementById(id).addEventListener('input', recalc);
});

/*** Init ***/
function init(){
  buildCharts();
  setLang('id'); // Pastikan fungsi i18n Anda dipanggil
  recalc();
}
init();
</script>
</body>
</html>
